# === 0) Vá»€ THÆ¯ Má»¤C REPO & Báº¬T VENV
cd ~/invoice-pipeline || { echo "âŒ KhÃ´ng tháº¥y ~/invoice-pipeline"; exit 1; }
python3 -m venv .venv 2>/dev/null || true
source .venv/bin/activate

# === 1) CÃ€I LIB CHO FE
python -m pip -q install --upgrade pip
python -m pip -q install streamlit==1.39.0 pandas requests \
  google-auth google-auth-oauthlib google-auth-httplib2 \
  openpyxl XlsxWriter

# === 2) Táº O THÆ¯ Má»¤C FE + FILE Cáº¤U HÃŒNH
mkdir -p fe/.streamlit
cat > fe/.streamlit/config.toml <<'CFG'
[server]
enableCORS = false
enableXsrfProtection = false
headless = true
port = 8080
address = "0.0.0.0"

[browser]
gatherUsageStats = false

[theme]
base="dark"
primaryColor="#08c19d"
CFG

# === 3) Táº O á»¨NG Dá»¤NG STREAMLIT (UI upload & convert)
cat > fe/streamlit_app.py <<'PY'
import io, os, requests
import streamlit as st

st.set_page_config(page_title="Invoice Pipeline â€“ Upload & Convert", layout="wide")

# --- Backend URL ---
DEFAULT_BACKEND = os.getenv("BACKEND_URL", "https://invoice-pipeline-160913806.asia-southeast1.run.app")
with st.expander("ðŸ”Œ Káº¿t ná»‘i Backend", expanded=True):
    backend = st.text_input("Backend:", value=DEFAULT_BACKEND, placeholder="https://<cloud-run>.a.run.app")
    colb1, colb2 = st.columns([1,6])
    with colb1:
        if st.button("Kiá»ƒm tra /health"):
            try:
                r = requests.get(f"{backend.rstrip('/')}/health", timeout=10)
                st.success(f"OK {r.status_code}: {r.text}")
            except Exception as e:
                st.error(f"Health check lá»—i: {e}")
    with colb2:
        st.caption("Nháº­p Ä‘Ãºng Cloud Run URL cá»§a API. VÃ­ dá»¥: https://invoice-pipeline-xxxxx-a-uc.a.run.app")

st.markdown("---")

# --- Upload zone ---
st.subheader("Chá»n nhiá»u XML (d1â€¦d5,â€¦)")
uploaded = st.file_uploader("Drag & Drop XML hoáº·c báº¥m 'Browse files'", type=["xml"], accept_multiple_files=True, label_visibility="collapsed")
merge = st.checkbox("Gá»™p nhiá»u file thÃ nh 1 Excel", value=True)

# --- Convert button ---
col1, col2 = st.columns([1,6])
with col1:
    go = st.button("ðŸš€ Convert")
with col2:
    st.caption("Backend endpoint: /pipeline/xml-to-xlsx")

# --- Logic ---
if go:
    if not backend:
        st.error("ChÆ°a nháº­p Backend URL.")
        st.stop()
    if not uploaded:
        st.warning("ChÆ°a chá»n file XML.")
        st.stop()

    st.info(f"Äang upload {len(uploaded)} file â†’ {backend}")
    files = []
    for f in uploaded:
        files.append(("xml_files", (f.name, f.getvalue(), "application/xml")))

    # query merge (náº¿u backend cÃ³ há»— trá»£). Náº¿u khÃ´ng cáº§n, váº«n OK.
    params = {"merge": "1" if merge else "0"}
    try:
        with st.spinner("Äang xá»­ lÃ½â€¦"):
            url = f"{backend.rstrip('/')}/pipeline/xml-to-xlsx"
            r = requests.post(url, files=files, params=params, timeout=120)
            if r.status_code != 200:
                st.error(f"Backend tráº£ vá» {r.status_code}: {r.text[:4000]}")
            else:
                out_name = "Data.xlsx" if merge else "Data.zip"
                st.success("âœ… Convert xong!")
                st.download_button("ðŸ“¥ Táº£i káº¿t quáº£", data=r.content, file_name=out_name, mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
    except Exception as e:
        st.error(f"Lá»—i gá»i API: {e}")

# Footer
st.caption("Â© Invoice Pipeline â€“ Streamlit FE")
PY

# === 4) SET BACKEND URL (THAY Báº°NG URL THáº¬T Cá»¦A EM)
export BACKEND_URL="https://YOUR-BACKEND-URL.a.run.app"

# === 5) CHáº Y FE (KILL PORT CÅ¨ Náº¾U CÃ“)
pkill -f "streamlit run" 2>/dev/null || true
python -m streamlit run fe/streamlit_app.py
